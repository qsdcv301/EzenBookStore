<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NNNNNNNNNNNNNNNotice</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script>
    <style>
        .container{
            display: flex;
        }
        .col-6{
            width: 50%;
        }
        .hidden{
            display: none;
        }
        .asdf{
            background: #888;
        }
        .innerAsdf{
            display: inline-block;
            background: #eee;
            border-radius: 3px;
            border: 1px solid #000000;
            padding: 20px;
        }
        .noticeTitle{
            padding-right: 10px;
            padding-left: 10px;
        }
        .noticeTitle::after{
            content: "";
            width: 2px;
            color: #000;
            height: 25px;
            position: relative;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="col-6">
        <h2>공지사항 관리</h2>
        <form id="addNoticeForm">
            <input type="text" id="title" placeholder="제목" required>
            <textarea id="content" placeholder="내용" required></textarea>
            <button type="button" id="addNotice">추가</button>
            <br>
            <select id="searchType">
                <option value="title">제목</option>
                <option value="content">내용</option>
            </select>
            <input type="text" id="keyword" placeholder="검색어를 입력하세요">
            <button type="button" id="btnSearch">검색</button>
        </form>
        <table>
            <tr>
                <td>체크박스</td>
                <td>notice번호</td>
                <td class="noticeTitle">공지사항 제목</td>
                <td>공지사항 내용</td>
            </tr>
            <tr th:each="noticePage : ${noticePage}">
                <td class="notice-check">
                    <input type="checkbox" id="noticeChecked" name="checkBox" />
                    <label for="noticeChecked"></label>
                </td>
                <td class="noticeId" th:text="${noticePage.id}"></td>
                <td class="noticeTitle" th:text="${noticePage.title}"></td>
                <td class="noticeContent" th:text="${noticePage.content}"></td>
                <td><button id='updateNotice'>수정</button></td>
            </tr>
        </table>
        <button id='selectAllNotice'>일괄선택</button>
        <button id='deleteNotice'>일괄삭제</button>
        <!-- 페이징 -->
        <div>
            <!-- 이전 페이지 그룹 -->
            <a th:if="${startPage > 0}"
                    th:href="@{/admin/notice(page=${startPage - 1}, size=${noticePage.size}, keyword=${keyword}, searchType=${searchType})}">
                이전
            </a>

            <!-- 페이지 번호 그룹 -->
            <span th:each="i : ${#numbers.sequence(startPage, endPage - 1)}">
        <a th:href="@{/admin/notice(page=${i}, size=${noticePage.size}, keyword=${keyword}, searchType=${searchType})}"
           th:text="${i + 1}"
           th:classappend="${noticePage.number == i ? 'active' : ''}"></a>
    </span>

            <!-- 다음 페이지 그룹 -->
            <a th:if="${endPage < noticePage.totalPages}"
                    th:href="@{/admin/notice(page=${endPage}, size=${noticePage.size}, keyword=${keyword}, searchType=${searchType})}">
                다음
            </a>
        </div>

    </div>

    <div class="col-6 hidden asdf" id="editForm">
        <div class="innerAsdf">
            <p>제목</p>
            <input type="text" id="editTitle">
            <p>내용</p>
            <textarea id="editContent"></textarea>
            <button type="button" id="saveUpdate">수정</button>
        </div>
    </div>
</div>
<!-- 스크립트 부분 -->
<script>
    // 공지사항 등록 처리 ajax
    $("#addNotice").click(function () {
        const title = $('#title').val();
        const content = $('#content').val();

        if (title && content) {
            $.ajax({
                url: '/admin/notice/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ title: title, content: content }),
                success: function (res) {
                    alert('공지사항이 추가되었습니다.');
                    location.reload(); // 성공 시 페이지 새로고침
                },
                error: function (xhr, status, error) {
                    console.error('에러',xhr,status,error);
                    alert('공지사항 등록 실패');
                }
            });
        } else {
            alert('제목과 내용을 입력해주세요.');
        }
    });

    // '수정' 버튼 클릭 시 하단 입력 폼에 데이터 전송
    $(document).on('click', '#updateNotice', function () {
        const row = $(this).closest('tr');
        const noticeId = row.find('.noticeId').text();
        const noticeTitle = row.find('.noticeTitle').text();
        const noticeContent = row.find('.noticeContent').text();

        // 하단 입력 폼에 데이터 채우기
        $('#editTitle').val(noticeTitle);
        $('#editContent').val(noticeContent);
        $('#editForm').removeClass('hidden').data('id', noticeId);
    });

    // 수정된 공지사항을 서버로 전송하는 ajax 요청
    $('#saveUpdate').click(function () {
        const noticeId = $('#editForm').data('id');
        const updatedTitle = $('#editTitle').val();
        const updatedContent = $('#editContent').val();

        if (updatedTitle && updatedContent) {
            $.ajax({
                url: '/admin/notice/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: noticeId,
                    title: updatedTitle,
                    content: updatedContent
                }),
                success: function (res) {
                    alert('공지사항이 수정되었습니다.');
                    location.reload(); // 수정 후 페이지 새로고침
                },
                error: function (xhr, status, error) {
                    console.error("에러", error);
                    alert("공지사항 수정 실패");
                }
            });
        } else {
            alert('수정할 제목과 내용을 입력해주세요.');
        }
    });
    // 공지사항 체크박스를 일괄 선택하기
    $('#selectAllNotice').click(function() {
        const allChecked = $('input[name="checkBox"]:checked').length === $('input[name="checkBox"]').length;

        // 모든 체크박스가 선택되어 있으면 해제, 그렇지 않으면 선택
        $('input[name="checkBox"]').prop('checked', !allChecked);

        // 버튼 텍스트 변경
        $(this).text(allChecked ? '일괄선택' : '선택해제');
    });


    // 선택된 공지사항 일괄 삭제
    $('#deleteNotice').click(function () {
        const selectedIds = [];
        $('input[name="checkBox"]:checked').each(function () {
            const noticeId = $(this).closest('tr').find('.noticeId').text();
            selectedIds.push(noticeId);
        });

        if (selectedIds.length > 0) {
            $.ajax({
                url: '/admin/notice/delete',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(selectedIds),
                success: function (res) {
                    alert('선택된 공지사항이 삭제되었습니다.');
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error('삭제 오류', error);
                    alert('공지사항 삭제 실패');
                }
            });
        } else {
            alert('삭제할 공지사항을 선택해주세요.');
        }
    });
    $("#btnSearch").click(function () {
        const searchType = $('#searchType').val(); // 검색 유형 (title/content)
        const keyword = $('#keyword').val(); // 검색어

        if (keyword.trim() === '') {
            alert('검색어를 입력해주세요.');
            return;
        }

        // 검색 요청 URL 생성 및 이동
        const url = `/admin/notice?searchType=${searchType}&keyword=${keyword}&page=0`;
        location.href = url;
    });
</script>
</body>
</html>