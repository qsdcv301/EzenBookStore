<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Event Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .container { margin-top: 20px; }
        .filter span { cursor: pointer; padding: 5px 10px; margin-right: 5px; border-radius: 5px; background: #e9ecef; }
        .filter span.active { background: #0d6efd; color: white; }
    </style>
</head>
<body>
<div>이벤트 추가시 formdata ->startdate 가 초까지 받아와서 초를 지우지않으면 수정작업이 불가능함. 검색기능 날라감 다시 구현해야함 파일 업로드구현할때 json타입으로 불가능하여 form enctype="multipart/form-data"로 바꾸는 와중에 오류 다수 출현 </div>
<div>이미지를 추가한 이벤트는 홈페이지에서 정상적으로 출력됨</div>
<div class="container">
    <h2>이벤트 관리</h2>
    <p>이곳은 이벤트 추가, 삭제, 수정을 위한 관리 페이지입니다.</p>

    <!-- 필터 영역 -->
    <div class="filter mb-3">
        <span class="filter-btn active" data-filter="all">전체</span>
        <span class="filter-btn" data-filter="upcoming">시작 전</span>
        <span class="filter-btn" data-filter="ongoing">진행 중</span>
        <span class="filter-btn" data-filter="ended">종료</span>
    </div>

    <!-- 검색 및 추가 버튼 -->
    <div class="d-flex justify-content-between mb-3">
        <form id="searchForm" class="d-flex">
            <select id="searchType" class="form-select me-2" style="width: 150px;">
                <option value="title">제목</option>
                <option value="content">내용</option>
            </select>
            <input type="text" id="keyword" class="form-control me-2" placeholder="검색어를 입력하세요">
            <button type="button" id="btnSearch" class="btn btn-primary">검색</button>
        </form>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">이벤트 추가</button>
    </div>

    <!-- 이벤트 리스트 -->
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>체크박스</th>
            <th>이벤트 번호</th>
            <th>제목</th>
            <th>내용</th>
            <th>시작일</th>
            <th>종료일</th>
            <th>이미지 개수</th>
            <th>수정</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="event, iterStat : ${eventPage}">
            <td><input type="checkbox" name="checkBox"></td>
            <td th:text="${event.id}">1</td>
            <td th:text="${event.title}">이벤트 제목</td>
            <td th:text="${event.content}">이벤트 내용</td>
            <td th:text="${#dates.format(event.startDate, 'yyyy-MM-dd HH:mm')}">2024-11-19</td>
            <td th:text="${#dates.format(event.endDate, 'yyyy-MM-dd HH:mm')}">2024-11-20</td>
            <td th:text="${imageCounts[iterStat.index]}">0</td> <!-- 이미지 개수 -->
            <td>
                <button type="button" class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#editModal" th:data-id="${event.id}">수정</button>
            </td>

        </tr>
        </tbody>
    </table>

    <button id="selectAllEvent">일괄선택</button>
    <button id="deleteEvent">일괄삭제</button>
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li th:if="${startPage > 0}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${startPage - 1}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}">이전</a>
                </li>
                <li th:each="i : ${#numbers.sequence(startPage, endPage - 1)}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${i}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}" th:text="${i + 1}"></a>
                </li>
                <li th:if="${endPage < eventPage.totalPages}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${endPage}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}">다음</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- 추가 모달 -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">이벤트 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="addTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="addTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="addContent" class="form-label">내용</label>
                        <textarea class="form-control" id="addContent" name="content" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addStartDate" class="form-label">시작일</label>
                        <input type="datetime-local" class="form-control" id="addStartDate" name="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEndDate" class="form-label">종료일</label>
                        <input type="datetime-local" class="form-control" id="addEndDate" name="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="addFile" class="form-label">이미지 업로드</label>
                        <input type="file" class="form-control" id="addFile" name="file" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="saveAdd">추가</button>
            </div>
        </div>
    </div>
</div>


<!-- 수정 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">이벤트 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <input type="hidden" id="editEventId" name="id">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">내용</label>
                        <textarea class="form-control" id="editContent" name="content" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editStartDate" class="form-label">시작일</label>
                        <input type="datetime-local" class="form-control" id="editStartDate" name="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEndDate" class="form-label">종료일</label>
                        <input type="datetime-local" class="form-control" id="editEndDate" name="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label>현재 이미지</label>
                        <div id="currentImages" class="mb-2"></div> <!-- 이미지 출력 공간 -->
                        <label for="editFile" class="form-label">이미지 업로드</label>
                        <input type="file" class="form-control" id="editFile" name="file" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="saveEdit">저장</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        // 검색 기능
        $('#btnSearch').click(function (event) {
            event.preventDefault();
            const searchType = $('#searchType').val();
            const keyword = $('#keyword').val().trim();

            if (!keyword) {
                alert('검색어를 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/admin/event',
                type: 'GET',
                data: { searchType, keyword },
                success: function (response) {
                    updateTable(response.content || response);
                },
                error: function (xhr) {
                    alert('검색 중 문제가 발생했습니다.');
                }
            });
        });

        // 필터 기능
        $('.filter-btn').click(function () {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');
            const filter = $(this).data('filter');

            $.ajax({
                url: '/admin/event/filter',
                type: 'GET',
                data: { filter },
                success: function (data) {
                    updateTable(data.content);
                },
                error: function () {
                    alert('필터 적용 실패');
                }
            });
        });

        // 테이블 업데이트
        function updateTable(events) {
            const tableBody = $('#eventTableBody');
            tableBody.empty();

            if (!events || events.length === 0) {
                tableBody.append('<tr><td colspan="8" class="text-center">검색 결과가 없습니다.</td></tr>');
                return;
            }

            events.forEach(event => {
                const row = `
            <tr>
                <td><input type="checkbox" name="checkBox"></td>
                <td>${event.id}</td>
                <td>${event.title}</td>
                <td>${event.content}</td>
                <td>${formatDate(event.startDate, false)}</td>
                <td>${formatDate(event.endDate, false)}</td>
                <td>${event.imageCount || 0}</td>
                <td>
                    <button type="button" class="btn btn-warning btn-sm edit-btn" data-id="${event.id}" data-bs-toggle="modal" data-bs-target="#editModal">수정</button>
                </td>
            </tr>`;
                tableBody.append(row);
            });
        }

        // 날짜 변환 함수
        function formatDate(dateTime, toServerFormat = true) {
            if (!dateTime) return null;
            if (toServerFormat) {
                return dateTime.replace('T', ' ') + ':00'; // 서버 형식으로 변환
            }
            return dateTime.substring(0, 16); // 클라이언트 형식으로 변환
        }

        // 이벤트 추가
        $('#saveAdd').click(function () {
            const formData = new FormData();
            formData.append('title', $('#addTitle').val());
            formData.append('content', $('#addContent').val());
            formData.append('startDate', formatDate($('#addStartDate').val()));
            formData.append('endDate', formatDate($('#addEndDate').val()));
            formData.append('file', $('#addFile')[0].files[0] || new Blob());

            $.ajax({
                url: '/admin/event/add',
                type: 'POST',
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                data: formData,
                success: function () {
                    alert('이벤트가 추가되었습니다.');
                    location.reload();
                },
                error: function (xhr) {
                    alert('이벤트 추가 실패');
                }
            });
        });

        // 이벤트 수정
        $('#saveEdit').click(function () {
            const data = {
                id: $('#editEventId').val(),
                title: $('#editTitle').val(),
                content: $('#editContent').val(),
                startDate: formatDate($('#editStartDate').val()),
                endDate: formatDate($('#editEndDate').val())
            };

            $.ajax({
                url: '/admin/event/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function () {
                    alert('이벤트가 수정되었습니다.');
                    location.reload();
                },
                error: function () {
                    alert('이벤트 수정 실패');
                }
            });
        });

        // 수정 모달 데이터 로드
        $(document).on('click', '.edit-btn', function () {
            const eventId = $(this).data('id');

            $.ajax({
                url: `/admin/event/${eventId}`,
                type: 'GET',
                success: function (response) {
                    $('#editEventId').val(response.id);
                    $('#editTitle').val(response.title);
                    $('#editContent').val(response.content);
                    $('#editStartDate').val(formatDate(response.startDate, false));
                    $('#editEndDate').val(formatDate(response.endDate, false));

                    const currentImagesContainer = $('#currentImages');
                    currentImagesContainer.empty();
                    if (response.imagePath) {
                        currentImagesContainer.append(`<img src="${response.imagePath}" style="width: 100px; height: auto;">`);
                    } else {
                        currentImagesContainer.append('<p>이미지가 없습니다.</p>');
                    }
                },
                error: function () {
                    alert('이벤트 데이터를 불러오는 데 실패했습니다.');
                }
            });
        });

        // 일괄 선택 및 삭제
        $('#selectAllEvent').click(function () {
            const allChecked = $('input[name="checkBox"]:checked').length === $('input[name="checkBox"]').length;
            $('input[name="checkBox"]').prop('checked', !allChecked);
            $(this).text(allChecked ? '일괄선택' : '선택해제');
        });

        $('#deleteEvent').click(function () {
            const selectedIds = $('input[name="checkBox"]:checked')
                .map(function () { return $(this).closest('tr').find('td:nth-child(2)').text(); })
                .get();

            if (selectedIds.length === 0) {
                alert('삭제할 이벤트를 선택해주세요.');
                return;
            }

            if (confirm('선택된 이벤트를 삭제하시겠습니까?')) {
                $.ajax({
                    url: '/admin/event/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds),
                    success: function () {
                        alert('선택된 이벤트가 삭제되었습니다.');
                        location.reload();
                    },
                    error: function () {
                        alert('이벤트 삭제 실패');
                    }
                });
            }
        });
    });
</script>
</body>
</html>
