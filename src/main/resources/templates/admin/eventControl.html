<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Event Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .container { margin-top: 20px; }
        .filter span { cursor: pointer; padding: 5px 10px; margin-right: 5px; border-radius: 5px; background: #e9ecef; }
        .filter span.active { background: #0d6efd; color: white; }
    </style>
</head>
<body>
<div>이벤트 추가시 formdata ->startdate 가 초까지 받아와서 초를 지우지않으면 수정작업이 불가능함. 검색기능 날라감 다시 구현해야함 파일 업로드구현할때 json타입으로 불가능하여 form enctype="multipart/form-data"로 바꾸는 와중에 오류 다수 출현 </div>
<div>이미지를 추가한 이벤트는 홈페이지에서 정상적으로 출력됨</div>
<div class="container">
    <h2>이벤트 관리</h2>
    <p>이곳은 이벤트 추가, 삭제, 수정을 위한 관리 페이지입니다.</p>

    <!-- 필터 영역 -->
    <div class="filter mb-3">
        <span class="filter-btn active" data-filter="all">전체</span>
        <span class="filter-btn" data-filter="upcoming">시작 전</span>
        <span class="filter-btn" data-filter="ongoing">진행 중</span>
        <span class="filter-btn" data-filter="ended">종료</span>
    </div>

    <!-- 검색 및 추가 버튼 -->
    <div class="d-flex justify-content-between mb-3">
        <form id="searchForm" class="d-flex">
            <select id="searchType" class="form-select me-2" style="width: 150px;">
                <option value="title">제목</option>
                <option value="content">내용</option>
            </select>
            <input type="text" id="keyword" class="form-control me-2" placeholder="검색어를 입력하세요">
            <button type="button" id="btnSearch" class="btn btn-primary">검색</button>
        </form>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">이벤트 추가</button>
    </div>

    <!-- 이벤트 리스트 -->
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>체크박스</th>
            <th>이벤트 번호</th>
            <th>제목</th>
            <th>내용</th>
            <th>시작일</th>
            <th>종료일</th>
            <th>이미지 개수</th>
            <th>수정</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="event, iterStat : ${eventPage}">
            <td><input type="checkbox" name="checkBox"></td>
            <td th:text="${event.id}">1</td>
            <td th:text="${event.title}">이벤트 제목</td>
            <td th:text="${event.content}">이벤트 내용</td>
            <td th:text="${#dates.format(event.startDate, 'yyyy-MM-dd HH:mm')}">2024-11-19</td>
            <td th:text="${#dates.format(event.endDate, 'yyyy-MM-dd HH:mm')}">2024-11-20</td>
            <td th:text="${imageCounts[iterStat.index]}">0</td> <!-- 이미지 개수 -->
            <td>
                <button type="button" class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#editModal" th:data-id="${event.id}">수정</button>
            </td>

        </tr>
        </tbody>
    </table>

    <button id="selectAllEvent">일괄선택</button>
    <button id="deleteEvent">일괄삭제</button>
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li th:if="${startPage > 0}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${startPage - 1}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}">이전</a>
                </li>
                <li th:each="i : ${#numbers.sequence(startPage, endPage - 1)}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${i}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}" th:text="${i + 1}"></a>
                </li>
                <li th:if="${endPage < eventPage.totalPages}" class="page-item">
                    <a class="page-link" th:href="@{/admin/event(page=${endPage}, size=${eventPage.size}, keyword=${keyword}, searchType=${searchType})}">다음</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- 추가 모달 -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">이벤트 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="addTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="addTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="addContent" class="form-label">내용</label>
                        <textarea class="form-control" id="addContent" name="content" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addStartDate" class="form-label">시작일</label>
                        <input type="datetime-local" class="form-control" id="addStartDate" name="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEndDate" class="form-label">종료일</label>
                        <input type="datetime-local" class="form-control" id="addEndDate" name="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="addFile" class="form-label">이미지 업로드</label>
                        <input type="file" class="form-control" id="addFile" name="file" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="saveAdd">추가</button>
            </div>
        </div>
    </div>
</div>


<!-- 수정 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">이벤트 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm" enctype="multipart/form-data">
                    <input type="hidden" id="editEventId" name="id">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">내용</label>
                        <textarea class="form-control" id="editContent" name="content" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editStartDate" class="form-label">시작일</label>
                        <input type="datetime-local" class="form-control" id="editStartDate" name="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEndDate" class="form-label">종료일</label>
                        <input type="datetime-local" class="form-control" id="editEndDate" name="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label>현재 이미지</label>
                        <div id="currentImages" class="mb-2">
                            <!-- 추가된 이미지 로드 -->
                        </div>
                        <label for="editFile" class="form-label">이미지 업로드</label>
                        <input type="file" class="form-control" id="editFile" name="file" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="saveEdit">저장</button>
            </div>
        </div>
    </div>
</div>


<script>
    // 필터 기능
    $('.filter-btn').click(function () {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        const filter = $(this).data('filter');

        // AJAX 요청
        $.ajax({
            url: '/admin/event/filter',
            type: 'GET',
            data: { filter: filter },
            success: function (data) {
                console.log(`${filter} 상태의 이벤트가 로드되었습니다.`);
                updateTable(data.content); // 테이블 업데이트 함수 호출
            },
            error: function (xhr, status, error) {
                console.error('필터 오류:', error);
                alert('필터 적용 실패');
            }
        });
    });

    // 테이블 업데이트 함수
    function updateTable(events) {
        const tableBody = $('table tbody');
        tableBody.empty(); // 기존 테이블 내용 비우기

        if (events.length === 0) {
            tableBody.append('<tr><td colspan="8" class="text-center">이벤트가 없습니다.</td></tr>');
            return;
        }

        // 필터링된 이벤트 데이터 추가
        events.forEach(event => {
            const row = `
        <tr>
            <td><input type="checkbox" name="checkBox"></td>
            <td>${event.id}</td>
            <td>${event.title}</td>
            <td>${event.content}</td>
            <td>${formatDate(event.startDate)}</td>
            <td>${formatDate(event.endDate)}</td>
            <td>${event.imageCount || 0}</td>
            <td>
                <button type="button" class="btn btn-warning btn-sm edit-btn" data-id="${event.id}" data-bs-toggle="modal" data-bs-target="#editModal">수정</button>
            </td>
        </tr>`;
            tableBody.append(row);
        });
    }
    $('#saveAdd').click(function () {
        // datetime-local 값을 가져와 Timestamp 형식으로 변환
        const startDate = $('#addStartDate').val().replace('T', ' ') + ':00';
        const endDate = $('#addEndDate').val().replace('T', ' ') + ':00';

        // FormData 생성 및 추가
        const formData = new FormData();
        formData.append('title', $('#addTitle').val());
        formData.append('content', $('#addContent').val());
        formData.append('startDate', startDate);
        formData.append('endDate', endDate);
        // 파일 추가
        formData.append('file', $('#addFile')[0].files[0] || new Blob()); // 빈 Blob 전달

        // AJAX 요청
        $.ajax({
            url: '/admin/event/add',
            type: 'POST',
            enctype: 'multipart/form-data', // multipart/form-data 설정
            processData: false, // 파일 데이터 처리를 막음
            contentType: false, // 기본 Content-Type 설정 비활성화
            cache: false,
            data: formData,
            success: function () {
                alert('이벤트가 추가되었습니다.');
                location.reload();
            },
            error: function (xhr) {
                console.error('추가 오류:', xhr.responseText);
                alert('이벤트 추가 실패: ' + xhr.responseText);
            }
        });
    });

    $('#saveEdit').click(function () {
        const eventId = $('#editEventId').val(); // 이벤트 ID 가져오기
        const title = $('#editTitle').val(); // 제목 가져오기
        const content = $('#editContent').val(); // 내용 가져오기
        const startDate = $('#editStartDate').val(); // 시작일 가져오기
        const endDate = $('#editEndDate').val(); // 종료일 가져오기

        // 입력 검증: 필수 값 체크
        if (!title || !content || !startDate || !endDate) {
            alert('모든 필드를 입력해주세요.');
            return;
        }

        // 서버가 이해할 수 있는 형식으로 변환
        const formattedStartDate = startDate.replace('T', ' ') + ':00'; // 'YYYY-MM-DD HH:mm:ss'
        const formattedEndDate = endDate.replace('T', ' ') + ':00'; // 'YYYY-MM-DD HH:mm:ss'

        // 데이터 준비
        const data = {
            id: eventId,
            title: title,
            content: content,
            startDate: formattedStartDate,
            endDate: formattedEndDate
        };

        // AJAX 요청
        $.ajax({
            url: '/admin/event/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function () {
                alert('이벤트가 수정되었습니다.');
                location.reload(); // 성공 시 페이지 새로고침
            },
            error: function (xhr) {
                console.error('수정 오류:', xhr.responseText);
                alert('이벤트 수정 실패: ' + xhr.responseText);
            }
        });
    });





    // 수정 모달 열기
    $(document).on('click', '.edit-btn', function () {
        const eventId = $(this).data('id'); // 이벤트 ID 가져오기

        // 서버에서 이벤트 데이터 가져오기
        $.ajax({
            url: `/admin/event/${eventId}`,
            type: 'GET',
            success: function (event) {
                // 데이터 채우기
                $('#editEventId').val(event.id); // ID 설정
                $('#editTitle').val(event.title); // 제목 설정
                $('#editContent').val(event.content); // 내용 설정

                // 시작일과 종료일을 datetime-local 형식으로 변환하여 설정
                $('#editStartDate').val(event.startDate.replace(' ', 'T')); // 'YYYY-MM-DD HH:mm:ss' -> 'YYYY-MM-DDTHH:mm'
                $('#editEndDate').val(event.endDate.replace(' ', 'T')); // 'YYYY-MM-DD HH:mm:ss' -> 'YYYY-MM-DDTHH:mm'

                const currentImagesContainer = $('#currentImages');
                currentImagesContainer.empty();

                // 이미지 렌더링
                const imagePath = event.imagePath || null;
                if (imagePath) {
                    const imageTag = `<img src="${imagePath}" style="width: 100px; height: auto; margin-right: 10px;">`;
                    currentImagesContainer.append(imageTag);
                } else {
                    currentImagesContainer.append('<p>이미지가 없습니다.</p>');
                }

                // 모달 열기
                $('#editModal').modal('show');
            },
            error: function () {
                alert('이벤트 정보를 불러오지 못했습니다.');
            }
        });
    });




    // 일괄선택 버튼 동작
    $('#selectAllEvent').click(function () {
        const allChecked = $('input[name="checkBox"]:checked').length === $('input[name="checkBox"]').length;

        // 모든 체크박스가 선택되어 있으면 해제, 그렇지 않으면 선택
        $('input[name="checkBox"]').prop('checked', !allChecked);

        // 버튼 텍스트 변경
        $(this).text(allChecked ? '일괄선택' : '선택해제');
    });

    // 일괄삭제 버튼 동작
    $('#deleteEvent').click(function () {
        const selectedIds = [];

        // 선택된 체크박스에서 이벤트 ID 수집
        $('input[name="checkBox"]:checked').each(function () {
            const eventId = $(this).closest('tr').find('td:nth-child(2)').text();
            selectedIds.push(eventId);
        });

        if (selectedIds.length > 0) {
            if (confirm('선택된 이벤트를 삭제하시겠습니까?')) {
                $.ajax({
                    url: '/admin/event/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds),
                    success: function () {
                        alert('선택된 이벤트가 삭제되었습니다.');
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error('삭제 오류:', error);
                        alert('이벤트 삭제 실패');
                    }
                });
            }
        } else {
            alert('삭제할 이벤트를 선택해주세요.');
        }
    });

    // 헬퍼 함수들
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16).replace('T', ' ');
    }
</script>
</body>
</html>
