<!DOCTYPE html>
<html lang="ko">
<head xmlns:th="http://www.thymeleaf.org">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 정보 관리</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .filter-option {
            cursor: pointer;
            padding: 10px 20px;
            margin-right: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            color: #495057;
            transition: background-color 0.3s;
        }

        .filter-option:hover {
            background-color: #6c757d;
            color: white;
        }

        .filter-option.active {
            background-color: #007bff;
            color: white;
        }

        .user-stats {
            display: block;
            text-align: left;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .user-stats span {
            display: inline-block;
            margin-right: 15px;
        }

        .user-stats span span{
            margin-left: 10px;
        }

        .user-stats span:not(:last-child)::after {
            content: '|';
            margin-left: 10px;
            color: #6c757d;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h3 class="font-weight-bold mb-4">회원 정보 관리</h3>
    <P>가입된 회원 정보를 확인하거나 수정할 수 있는 페이지입니다.</P>

    <!-- 필터 버튼 -->
    <div class="d-flex justify-content-start mb-3">
    <span class="filter-option" th:classappend="${grade == null ? 'active' : ''}"
          th:onclick="'location.href=\'/admin/user/filter\''">전체 <span th:text="${totalCount}"></span></span>
        <span class="filter-option" th:classappend="${grade == 0 ? 'active' : ''}"
              th:onclick="'location.href=\'/admin/user/filter?grade=0\''">일반회원 <span th:text="${generalCount}"></span></span>
        <span class="filter-option" th:classappend="${grade == 1 ? 'active' : ''}"
              th:onclick="'location.href=\'/admin/user/filter?grade=1\''">실버회원 <span th:text="${silverCount}"></span></span>
        <span class="filter-option" th:classappend="${grade == 2 ? 'active' : ''}"
              th:onclick="'location.href=\'/admin/user/filter?grade=2\''">골드회원 <span th:text="${goldCount}"></span></span>
        <span class="filter-option" th:classappend="${grade == 3 ? 'active' : ''}"
              th:onclick="'location.href=\'/admin/user/filter?grade=3\''">VIP 회원 <span th:text="${vipCount}"></span></span>
        <span class="filter-option" th:classappend="${grade == 4 ? 'active' : ''}"
              th:onclick="'location.href=\'/admin/user/filter?grade=4\''">관리자 <span th:text="${adminCount}"></span></span>
    </div>
    <hr>

    <!-- 검색 및 상태 변경 섹션 -->
    <div class="d-flex justify-content-between mb-3">
        <!-- 검색 섹션 -->
        <div class="search-section d-flex align-items-center">
            <select class="form-control mr-2" style="width: 150px;" id="search-type">
                <option value="email">이메일</option>
                <option value="name">이름</option>
            </select>
            <input type="text" class="form-control mr-2" placeholder="검색어를 입력하세요" style="width: 300px;" id="search-input">
            <button class="btn btn-secondary" onclick="searchUsers()">조회</button>
        </div>

        <!-- 등급 상태 변경 -->
        <div class="d-flex align-items-center">
            <select class="form-control mr-3" style="width: 200px;" id="bulk-status">
                <option value="">등급 상태 변경</option>
                <option value="0">일반회원</option>
                <option value="1">실버회원</option>
                <option value="2">골드회원</option>
                <option value="3">VIP 회원</option>
                <option value="4">관리자</option>
            </select>
            <button class="btn btn-primary" onclick="updateBulkStatus()">수정</button>
            <button class="btn btn-danger ml-2" onclick="deleteSelected()">삭제</button>
        </div>
    </div>

    <!-- 회원 목록 테이블 -->
    <table class="table table-bordered text-center">
        <thead class="thead-light">
        <tr>
            <th><input type="checkbox" id="select-all" onclick="toggleAllCheckboxes(this)"></th>
            <th>가입순서</th>
            <th>아이디(이메일형식)</th>
            <th>이름</th>
            <th>전화번호</th>
            <th>주소</th>
            <th>회원등급</th>
            <th>상세보기</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${userList}">
            <td><input type="checkbox" class="user-checkbox" th:data-id="${user.id}"></td>
            <td th:text="${user.id}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${user.name}"></td>
            <td th:text="${user.tel}"></td>
            <td>
                <span th:text="${user.addr}"></span>
                <span th:if="${user.addrextra != null}" th:text="' ' + ${user.addrextra}"></span>
            </td>
            <td>
                <select class="form-control" name="grade" th:value="${user.grade}">
                    <option value="0" th:selected="${user.grade == 0}">일반회원</option>
                    <option value="1" th:selected="${user.grade == 1}">실버회원</option>
                    <option value="2" th:selected="${user.grade == 2}">골드회원</option>
                    <option value="3" th:selected="${user.grade == 3}">VIP 회원</option>
                    <option value="4" th:selected="${user.grade == 4}">관리자</option>
                </select>
            </td>
            <td>
                <button class="btn btn-primary" th:data-target="'#userDetailModal-' + ${user.id}" data-toggle="modal">상세</button>
            </td>
        </tr>
        </tbody>
    </table>


    <!-- 페이지네이션 -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                th:classappend="${i == currentPage ? 'active' : ''}">
                <a class="page-link" th:href="@{/admin/user(page=${i})}" th:text="${i}"></a>
            </li>
        </ul>
    </nav>
</div>


<!-- 모달 템플릿 -->
<div th:each="user : ${userList}" class="modal fade" th:id="'userDetailModal-' + ${user.id}" tabindex="-1" role="dialog" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="'회원 상세 정보 - ' + ${user.name}"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>회원 ID:</strong> <span th:text="${user.id}"></span></p>
                <p><strong>가입경로:</strong> <span th:text="${user.provider}"></span></p>
                <p><strong>아이디(이메일):</strong> <span th:text="${user.email}"></span></p>
                <p><strong>이름:</strong> <span th:text="${user.name}"></span></p>
                <p><strong>전화번호:</strong> <span th:text="${user.tel}"></span></p>
                <p><strong>주소:</strong>
                    <span th:text="${user.addr}"></span>
                    <span th:if="${user.addrextra != null}" th:text="' ' + ${user.addrextra}"></span>
                </p>
                <p><strong>생년월일:</strong> <span th:text="${user.birthday}"></span></p>
                <p><strong>회원 등급:</strong>
                    <span th:switch="${user.grade}">
                        <span th:case="0">일반회원</span>
                        <span th:case="1">실버회원</span>
                        <span th:case="2">골드회원</span>
                        <span th:case="3">VIP회원</span>
                        <span th:case="4">관리자</span>
                    </span>
                </p>
                <p><strong>포인트:</strong> <span th:text="${user.point}"></span></p>
                <p><strong>가입일:</strong> <span th:text="${#dates.format(user.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></p>
                <div class="d-flex mt-3">
                    <button class="btn btn-secondary mr-2" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    function filterUsers(level) {
        // 필터된 사용자 리스트
        const filteredUsers = level === '전체' ? users : users.filter(user => user.level === level);

        // 필터링된 사용자 목록 업데이트
        const userListElement = document.getElementById('user-list');
        userListElement.innerHTML = ''; // 기존 목록 제거

        filteredUsers.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${user.signupOrder}</td>
        <td>${user.email}</td>
        <td>${user.name}</td>
        <td>${user.phone}</td>
        <td>${user.address}</td>
        <td>${user.level}</td>
        <td><button class="btn btn-primary" onclick="openEditModal(${user.signupOrder})">상세</button></td>
      `;
            userListElement.appendChild(tr);
        });

        updateFilterCounts(level);

        // 필터 버튼의 active 클래스 처리
        const filterButtons = document.querySelectorAll('.filter-option');
        filterButtons.forEach(button => {
            button.classList.remove('active');  // 기존 active 클래스 제거
        });

        // 클릭한 버튼에 active 클래스 추가
        const activeButton = Array.from(filterButtons).find(button => button.textContent.includes(level));
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function updateFilterCounts(level) {
        const totalCount = users.length;
        const generalCount = users.filter(user => user.level === '일반회원').length;
        const silverCount = users.filter(user => user.level === '실버회원').length;
        const goldCount = users.filter(user => user.level === '골드회원').length;
        const vipCount = users.filter(user => user.level === 'VIP회원').length;
        const adminCount = users.filter(user => user.level === '관리자').length;

        document.getElementById('total-count').textContent = `(${totalCount}명)`;
        document.getElementById('general-count').textContent = `(${generalCount}명)`;
        document.getElementById('silver-count').textContent = `(${silverCount}명)`;
        document.getElementById('gold-count').textContent = `(${goldCount}명)`;
        document.getElementById('vip-count').textContent = `(${vipCount}명)`;
        document.getElementById('admin-count').textContent = `(${adminCount}명)`;
    }



    function searchUsers() {
        const searchType = document.getElementById('search-type').value;
        const searchText = document.getElementById('search-input').value.trim().toLowerCase();

        const filteredUsers = users.filter(user => {
            return user[searchType].toLowerCase().includes(searchText);
        });

        // 필터링된 사용자 목록 업데이트
        const userListElement = document.getElementById('user-list');
        userListElement.innerHTML = ''; // 기존 목록 제거

        filteredUsers.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${user.signupOrder}</td>
        <td>${user.email}</td>
        <td>${user.name}</td>
        <td>${user.phone}</td>
        <td>${user.address}</td>
        <td>${user.level}</td>
        <td><button class="btn btn-primary" onclick="openEditModal(${user.signupOrder})">수정</button></td>
      `;
            userListElement.appendChild(tr);
        });
    }

    // 페이지 로드 시, 초기화
    window.onload = () => {
        filterUsers('전체');
    };

    //체크박스 일괄체크/해제
    function toggleAllCheckboxes(checkbox) {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    //등급상태 일괄변경
    function updateBulkStatus() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.user-checkbox:checked'));
        const selectedIds = selectedCheckboxes.map(cb => cb.getAttribute('data-id'));
        const newStatus = document.getElementById('bulk-status').value;

        if (!newStatus) {
            alert('변경할 등급을 선택하세요.');
            return;
        }

        if (selectedIds.length === 0) {
            alert('선택된 사용자가 없습니다.');
            return;
        }

        // 서버로 상태 변경 요청
        console.log(`등급 상태 변경: ${selectedIds} -> ${newStatus}`);
        alert(`선택된 사용자들의 등급 상태가 '${newStatus}'로 변경되었습니다.`);
    }

    //선택항목 삭제
    function deleteSelected() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.user-checkbox:checked'));
        const selectedIds = selectedCheckboxes.map(cb => cb.getAttribute('data-id'));

        if (selectedIds.length === 0) {
            alert('삭제할 사용자를 선택하세요.');
            return;
        }

        // 서버로 삭제 요청
        console.log(`삭제 요청: ${selectedIds}`);
        alert('선택된 사용자들이 삭제되었습니다.');
    }


</script>

</body>
</html>
