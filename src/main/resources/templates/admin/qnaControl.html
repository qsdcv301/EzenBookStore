<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/css :: css}">
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>문의하기 관리 페이지</title>
</head>
<body>
<div class="container-fluid adminQnA-container">
    <div class="row">
        <nav th:replace="~{fragments/sidebar :: sidebar}"></nav>
        <main class="col-10 content">
            <div class="container mt-5">
                <h2>문의하기 관리</h2>
                <p>카테고리별 문의를 확인하고 관리할 수 있는 페이지입니다.</p>

                <!-- 카테고리 필터 -->
                <!-- 필터 버튼들을 통해 카테고리에 따라 리스트를 필터링하는 기능 -->
                <div class="d-flex justify-content-start filter mb-3">
                    <span class="filter-btn" th:classappend="${currentCategory == 'all'} ? ' active'" data-filter="all">전체</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '1'} ? ' active'" data-filter="1">회원 문의</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '2'} ? ' active'" data-filter="2">상품 문의</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '3'} ? ' active'" data-filter="3">배송 문의</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '4'} ? ' active'" data-filter="4">주문 문의</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '5'} ? ' active'" data-filter="5">취소/반품 문의</span>
                    <span class="filter-btn" th:classappend="${currentCategory == '6'} ? ' active'" data-filter="6">기타 문의</span>
                </div>

                <hr>

                <div class="d-flex justify-content-between filter mb-3">
                    <!-- 답변 상태 필터 -->
                    <!-- 드롭다운을 통한 '모든 상태/답변 완료/답변 대기중' 필터링 기능 -->
                    <form id="searchForm" class="form-inline">
                        <select id="answerStatusFilter" class="form-control mr-2"
                                style="width: 200px; display: inline-block;">
                            <option value="all" th:selected="${currentStatus == 'all'}">모든 상태</option>
                            <option value="answered" th:selected="${currentStatus == 'answered'}">답변 완료</option>
                            <option value="pending" th:selected="${currentStatus == 'pending'}">답변 대기중</option>
                        </select>
                        <!-- 초기화 버튼: 필터 상태를 초기화하고 전체 보기로 돌아간다 -->
                        <button type="button" class="btn btn-secondary btnResetQnA mr-2">초기화</button>
                        <!-- 상태 필터 적용 버튼 -->
                        <button id="filterStatus" class="btn btn-primary mr-2">상태 필터 적용</button>
                    </form>

                    <!-- 일괄 답변 버튼: 여러 항목을 한 번에 처리할 때 사용 -->
                    <div>
                        <button id="bulkAnswer" class="btn btn-success">일괄 답변</button>
                    </div>
                </div>

                <!-- QnA 테이블 -->
                <!-- QnA 리스트를 테이블 형태로 보여준다 -->
                <!-- 각 항목에는 체크박스, QnA 아이디, 유저 이름, 카테고리, 제목, 답변 상태, 상세보기 버튼이 있다 -->
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                    <tr>
                        <th><input type="checkbox" id="selectAllQnA"></th>
                        <th>QnA 아이디</th>
                        <th>유저 이름</th>
                        <th>질문 카테고리</th>
                        <th>질문 제목</th>
                        <th>질문 답변 상태</th>
                        <th>상세보기</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="qnA : ${qnAPage}"
                        th:data-category="${qnA.category}"
                        th:data-status="${qnA.answer != null and !#strings.isEmpty(qnA.answer) ? 'answered' : 'pending'}"
                        th:data-image-path="${@thymeleafFileUploadService.findImageFilePath(qnA.id, 'qna')}">
                        <td><input type="checkbox" name="checkBoxQnA" th:value="${qnA.id}"></td>
                        <td th:text="${qnA.id}"></td>
                        <td th:text="${qnA.user.name}"></td>
                        <td>
                            <span th:switch="${qnA.category}">
                                <span th:case="'1'">회원 문의</span>
                                <span th:case="'2'">상품 문의</span>
                                <span th:case="'3'">배송 문의</span>
                                <span th:case="'4'">주문 문의</span>
                                <span th:case="'5'">취소/반품 문의</span>
                                <span th:case="'6'">기타 문의</span>
                                <span th:case="*">기타 문의</span>
                            </span>
                        </td>
                        <td th:text="${qnA.title}"></td>
                        <td th:text="${qnA.answer != null and !#strings.isEmpty(qnA.answer) ? '답변됨' : '답변 대기중'}"></td>
                        <td>
                            <!-- 상세보기 버튼 클릭 시 해당 QnA 상세 정보를 ajax로 불러와 모달에 표시 -->
                            <button type="button" class="btn btn-info btn-sm view-btn" th:attr="data-qna-id=${qnA.id}">
                                상세보기
                            </button>
                        </td>
                        <input type="hidden" class="hiddenImg"
                               th:value="${@thymeleafFileUploadService.findImageFilePath(qnA.id, 'qna')}">
                    </tr>
                    <!-- 검색 결과가 없을 경우 표시 -->
                    <tr th:if="${#lists.isEmpty(qnAPage?.content)}">
                        <td colspan="7" class="text-center">검색 결과가 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<!-- 페이지 네비게이션 -->
<!-- 페이지 이동 링크를 제공 -->
<div class="d-flex justify-content-center">
    <ul class="pagination">
        <!-- 이전 페이지 링크 -->
        <li class="page-item" th:if="${qnAPage.hasPrevious()}">
            <a class="page-link"
               th:href="@{/admin/qna(page=${qnAPage.number - 1}, size=${qnAPage.size}, category=${currentCategory}, status=${currentStatus})}">이전</a>
        </li>

        <!-- 페이지 번호 반복 -->
        <li class="page-item" th:each="i : ${#numbers.sequence(0, qnAPage.totalPages - 1)}"
            th:classappend="${i == qnAPage.number} ? 'active'">
            <a class="page-link"
               th:href="@{/admin/qna(page=${i}, size=${qnAPage.size}, category=${currentCategory}, status=${currentStatus})}"
               th:text="${i + 1}"></a>
        </li>

        <!-- 다음 페이지 링크 -->
        <li class="page-item" th:if="${qnAPage.hasNext()}">
            <a class="page-link"
               th:href="@{/admin/qna(page=${qnAPage.number + 1}, size=${qnAPage.size}, category=${currentCategory}, status=${currentStatus})}">다음</a>
        </li>
    </ul>
</div>

<!-- QnA 상세보기 모달 -->
<!-- 특정 QnA의 상세 정보를 확인하고, 답변을 등록/수정하는 모달 -->
<div class="modal fade" id="qnaDetailModal" tabindex="-1" role="dialog" aria-labelledby="qnaDetailModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">문의하기 상세보기</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="닫기">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <p><strong>QnA ID:</strong> <span id="detailQnAId"></span></p>
                    <p><strong>유저 이름:</strong> <span id="detailUserName"></span></p>
                    <p><strong>카테고리:</strong> <span id="detailCategory"></span></p>
                    <p><strong>질문 제목:</strong> <span id="detailTitle"></span></p>
                    <p><strong>질문 내용:</strong> <span id="detailQuestion"></span></p>
                    <p class="modalImgPTag"><strong>이미지파일 첨부확인</strong></p>
                    <img id="detailImg" src="" style="max-width: 100%; height: auto; display: none;"/>
                    <p><strong>답변:</strong></p>
                    <textarea id="editAnswer" class="form-control"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <!-- 답변 저장 버튼: 모달 내에서 입력한 답변을 서버로 전송 -->
                <button type="button" class="btn btn-primary" id="saveAnswer">답변 저장</button>
            </div>
        </div>
    </div>
</div>
<!-- 일괄 답변 모달 -->
<div class="modal fade" id="bulkAnswerModal" tabindex="-1" role="dialog" aria-labelledby="bulkAnswerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일괄 답변</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="닫기">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 선택된 질문 리스트 영역 -->
                <div class="selected-qna-list mb-3">
                    <div class="d-flex align-items-center mb-3">
                        <h6 class="mb-0 mr-2">선택된 질문 리스트</h6>
                        <button id="toggleListBtn" class="btn btn-secondary">+</button>
                    </div>
                    <div id="selectedQnAListContainer" style="display: none;">
                        <ul id="selectedQnAList" class="list-group">
                            <!-- 선택된 질문 항목 동적 추가 -->
                        </ul>
                    </div>
                </div>

                <!-- 상세 테이블 영역 -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-3">
                        <h6 class="mb-0 mr-2">상세테이블</h6>
                        <button id="toggleDetailsBtn" class="btn btn-secondary">+</button>
                    </div>
                    <div id="detailsTableContainer" style="display: none;">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                            <tr>
                                <th>Select</th>
                                <th>제목</th>
                                <th>작성자 이름</th>
                                <th>질문 내용 확인</th>
                            </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                            <!-- 동적으로 상세 내용 삽입 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 일괄 답변 내용 위에 Dropdown 추가 -->
                <div class="form-group">
                    <label for="bulkAnswerDropdown">일괄 답변 선택</label>
                    <select id="bulkAnswerDropdown" class="form-control mb-3">
                        <!-- 옵션 미입력 -->
                    </select>
                </div>

                <!-- 일괄 답변 내용 -->
                <div class="form-group">
                    <label for="bulkAnswerTextarea">일괄 답변 내용</label>
                    <textarea id="bulkAnswerTextarea" class="form-control" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveBulkAnswer">일괄 답변 저장</button>
            </div>
        </div>
    </div>
</div>


<!-- 스크립트 포함 -->
<div th:replace="~{fragments/script :: script-body}"></div>

<script th:inline="javascript">
    // 전역에서 접근 가능한 함수
    function restoreFilters() {
        const currentCategory = /*[[${currentCategory}]]*/ 'all';
        const currentStatus = /*[[${currentStatus}]]*/ 'all';

        $('.filter-btn').removeClass('active');
        $(`.filter-btn[data-filter="${currentCategory}"]`).addClass('active');

        $('#answerStatusFilter').val(currentStatus);
    }

    $(document).ready(function (){

        function revertFormattedContent(data) {
            let text;
            if (typeof data === 'object' && data !== null) {
                text = JSON.stringify(data);
            } else if (typeof data === 'string') {
                text = data;
            } else {
                console.warn(data);
                return '';
            }
            return text
                .replace(/\r/g, '')
                .replace(/\n/g, '<br>')
                .replace(/&nbsp;/g, ' ');
        }

        function formatTextContent(text) {
            return text
                .replace(/\r/g, '')
                .replace(/<br\s*\/?>/g, '\n')
                .replace(/&nbsp;/g, ' ');
        }

        function htmlToPlainText(htmlText) {
            if (!htmlText) return '';
            return htmlText
                .replace(/<br\s*\/?>/g, '\n')
                .replace(/&nbsp;/g, ' ');
        }

        // 필터 초기화 버튼
        $('.btnResetQnA').click(function (event) {
            event.preventDefault();
            window.location.href = '/admin/qna';
        });

        function applyFilters() {
            const categoryFilter = $('.filter-btn.active').data('filter') || 'all';
            const statusFilter = $('#answerStatusFilter').val() || 'all';
            const currentPage = /*[[${qnAPage.number}]]*/ 0;

            window.location.href = `/admin/qna?page=${currentPage}&size=15&category=${categoryFilter}&status=${statusFilter}`;
        }

        // 상세보기 모달 열기 (QnA 상세 정보 AJAX)
        $(document).on('click', '.view-btn', function () {
            const qnaId = $(this).data('qna-id');

            $.ajax({
                url: `/admin/qna/${qnaId}`,
                type: 'GET',
                success: function (response) {
                    $('#detailQnAId').text(qnaId);
                    $('#detailUserName').text(response.name);
                    $('#detailCategory').text(response.category);
                    $('#detailQuestion').html(response.question);
                    $('#detailTitle').text(response.title);

                    $('#editAnswer').val(htmlToPlainText(response.answer || ''));

                    if (response.imagePath) {
                        $('#detailImg').attr('src', response.imagePath).show();
                    } else {
                        $('#detailImg').hide();
                    }

                    $('#qnaDetailModal').modal('show');
                },
                error: function () {
                    alert('QnA 상세 정보를 불러오는 데 실패했습니다.');
                }
            });
        });

        // QnA 상세 답변 저장
        $('#saveAnswer').click(function () {
            const qnaId = $('#detailQnAId').text();
            const answer = formatTextContent($('#editAnswer').val());
            const currentCategory = /*[[${currentCategory}]]*/ 'all';
            const currentStatus = /*[[${currentStatus}]]*/ 'all';
            const currentPage = /*[[${qnAPage.number}]]*/ 0;

            $.ajax({
                url: `/admin/qna/${qnaId}/answer`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({answer}),
                success: function () {
                    alert('답변이 저장되었습니다.');
                    $('#qnaDetailModal').modal('hide');
                    window.location.href = `/admin/qna?page=${currentPage}&size=15&category=${currentCategory}&status=${currentStatus}`;
                },
                error: function () {
                    alert('답변 저장에 실패했습니다.');
                }
            });
        });

        // 필터 버튼 클릭 시 필터 적용
        $(document).on('click', '.filter-btn', function () {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');
            applyFilters();
        });

        $('#filterStatus').click(function (event) {
            event.preventDefault();
            applyFilters();
        });

        // 전체 선택 체크박스
        $('#selectAllQnA').click(function () {
            $('input[name="checkBoxQnA"]').prop('checked', this.checked);
        });

        $('input[name="checkBoxQnA"]').click(function () {
            const selectedIds = $('input[name="checkBoxQnA"]:checked').map(function () {
                return $(this).val();
            }).get();
            const checkBox = $('input[name="checkBoxQnA"]');

            if (selectedIds.length == checkBox.length) {
                $('#selectAllQnA').prop('checked', true);
            } else {
                $('#selectAllQnA').prop('checked', false);
            }
        });

        let selectedQnAs = [];

        // 일괄 답변 모달 열기
        $('#bulkAnswer').click(function () {
            selectedQnAs = $('input[name="checkBoxQnA"]:checked').map(function () {
                return {
                    id: $(this).val(),
                    title: $(this).closest('tr').find('td').eq(4).text(),
                    userName: $(this).closest('tr').find('td').eq(2).text(),
                    question: $(this).closest('tr').find('td').eq(5).text()
                };
            }).get();

            if (selectedQnAs.length === 0) {
                alert('선택된 질문이 없습니다.');
                return;
            }

            $('#selectedQnAList').empty();
            selectedQnAs.forEach(qna => {
                $('#selectedQnAList').append(`<li class="list-group-item">${qna.title} - ${qna.userName}</li>`);
            });

            $('#bulkAnswerModal').modal('show');
        });

        // 선택된 질문 리스트 토글
        $('#toggleListBtn').click(function () {
            if ($('#selectedQnAListContainer').is(':hidden')) {
                $('#selectedQnAListContainer').show();
                $(this).text('-');
            } else {
                $('#selectedQnAListContainer').hide();
                $(this).text('+');
            }
        });

        // 상세 테이블 토글
        $('#toggleDetailsBtn').click(function () {
            if ($('#detailsTableContainer').is(':hidden')) {
                $('#detailsTableContainer').show();
                $(this).text('-');
                // 상세테이블 채우기
                $('#detailsTableBody').empty();
                selectedQnAs.forEach(qna => {
                    $('#detailsTableBody').append(`
                        <tr class="question-row" data-qna-id="${qna.id}">
                            <td><input type="checkbox" class="detail-select" value="${qna.id}" checked></td>
                            <td>${qna.title}</td>
                            <td>${qna.userName}</td>
                            <td>
                                <button class="btn btn-sm btn-info show-detail-content">질문내용 상세보기(+)</button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                $('#detailsTableContainer').hide();
                $(this).text('+');
            }
        });

        // 질문내용 상세보기(+)
        $(document).on('click', '.show-detail-content', function () {
            const $row = $(this).closest('tr');
            const qnaId = $row.data('qna-id');
            const qnaObj = selectedQnAs.find(q => q.id == qnaId);

            if (!qnaObj) {
                console.error(`해당 qnaId(${qnaId})에 대응하는 qnaObj를 찾지 못했습니다.`);
                return;
            }

            if ($row.next().hasClass('detail-row')) {
                return;
            }

            $(this).text('질문내용 상세보기(-)')
                .removeClass('show-detail-content')
                .addClass('hide-detail-content');

            const detailTr = `
                <tr class="detail-row">
                    <td colspan="4">
                        <div style="border:1px solid #ccc; padding:10px; margin:5px 0;">
                            ${qnaObj.question}
                            <br>
                            <button class="btn btn-sm btn-warning close-detail-row">-</button>
                        </div>
                    </td>
                </tr>
            `;
            $row.after(detailTr);
        });

        // 상세내용 닫기(-)
        $(document).on('click', '.close-detail-row', function () {
            const $detailRow = $(this).closest('tr.detail-row');
            const $questionRow = $detailRow.prev('.question-row');
            $questionRow.find('.hide-detail-content')
                .text('질문내용 상세보기(+)')
                .removeClass('hide-detail-content')
                .addClass('show-detail-content');

            $detailRow.remove();
        });

        // hide-detail-content 상태일 때 클릭하면 접기
        $(document).on('click', '.hide-detail-content', function () {
            const $row = $(this).closest('tr.question-row');
            const $detailRow = $row.next('.detail-row');
            $detailRow.remove();
            $(this).text('질문내용 상세보기(+)')
                .removeClass('hide-detail-content')
                .addClass('show-detail-content');
        });

        // 일괄 답변 저장
        $('#saveBulkAnswer').click(function () {
            const answer = $('#bulkAnswerTextarea').val();
            if (!answer) {
                alert('답변 내용을 입력해 주세요.');
                return;
            }

            const ids = selectedQnAs.map(qna => qna.id);

            $.ajax({
                url: `/admin/qna/bulk-answer`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ids: ids, answer: answer }),
                success: function () {
                    alert(`${ids.join(', ')}에 대한 일괄 답변을 하였습니다.`);
                    $('#bulkAnswerModal').modal('hide');
                    window.location.reload();
                },
                error: function () {
                    alert('일괄 답변 저장에 실패했습니다.');
                }
            });
        });
    });

    $(document).ready(function () {
        $('.close').click(function () {
            $('#qnaDetailModal').modal('hide');
        });
        restoreFilters();
    });

    function parseLong(value) {
        return parseInt(value, 10);
    }
</script>
</body>
</html>
